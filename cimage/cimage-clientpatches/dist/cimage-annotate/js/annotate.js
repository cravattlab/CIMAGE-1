define(["jquery","underscore"],function(t,e){function n(){t.ajax({url:"/annotate",data:{data:JSON.stringify({file:window.location.href})}}).success(function(n){if(r=JSON.parse(n)){r._id=r._id.$oid;var i=e.pluck(r.annotations,"link");t('input[type="checkbox"]').each(function(){if(i.length){var e=t(this),n=e.parent().prev().text().trim(),a=i.indexOf(n);-1!=a&&(e.prop("checked",!0),i.splice(a,1))}})}})}function i(n){var i={ipi:1,symbol:3,sequence:4,charge:o?9:11,segment:o?10:12,link:o?11:13},a=n.parent().siblings(),r={sequence:t.trim(a.eq(i.sequence).text()),charge:Math.round(a.eq(i.charge).text()),segment:Math.round(a.eq(i.segment).text()),link:t.trim(a.eq(i.link).text())};if(!o){var c=n.parents("tr");do c=c.prev();while(!t.trim(c.text()));a=c.children()}return e.extend(r,{ipi:t.trim(a.eq(i.ipi).text()),symbol:t.trim(a.eq(i.symbol).text()),index:Math.round(r.link.split(".")[0])})}function a(){console.log(r);var n=r||{file:window.location.href,annotations:[]};n._id=n.file,r=n;var a=t(this),o=i(a);a.prop("checked")?n.annotations.push(o):n.annotations=e.reject(n.annotations,function(t){return e.isEqual(t,o)}),t.ajax({type:"POST",url:"/cgi-bin/radu/annotate.py",data:JSON.stringify(n)}),t.ajax({url:"/annotate",data:{data:JSON.stringify(n)}})}var r={},o=!1;t(function(){var e=t("tbody tr"),i=e.eq(0).find("th:last");i.after(i.clone().text("annotate")),e.eq(1).find("th:last").after(i.clone().empty()),t("colgroup:last").after("<colgroup span=1 />"),e=e.slice(2),o=!t.trim(e.eq(0).children("td").eq(1).text()),e.append("<td />");var r=t('<input type="checkbox" />');e.each(function(){var e=t(this);t.trim(e.find("td:first").text())||e.find("td:last").html(r.clone())}),n(),t('input[type="checkbox"]').on("change",a)})});